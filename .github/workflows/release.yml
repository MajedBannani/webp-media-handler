name: Build and release plugin ZIP

# This workflow ensures every GitHub Release includes a ready-to-install plugin ZIP.
# WordPress requires plugins to be installed from ZIPs that extract to a stable folder name.
# GitHub's automatic "Source code (zip)" downloads extract to versioned folders like:
# - webp-media-handler-v1.0.9/
# - webp-media-handler-main/
# These cause WordPress to treat updates as new plugins, leading to deactivation errors.
# Therefore, we MUST build and upload a properly structured ZIP as a release asset.
# The workflow will FAIL if the ZIP is missing or has incorrect structure.

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build plugin ZIP
        env:
          PLUGIN_SLUG: webp-media-handler
          MAIN_FILE: webp-media-handler.php
        run: |
          set -euo pipefail

          BUILD_DIR="${GITHUB_WORKSPACE}/build"
          rm -rf "${BUILD_DIR}"
          mkdir -p "${BUILD_DIR}/${PLUGIN_SLUG}"

          # Copy plugin files, excluding non-plugin files
          rsync -a --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "node_modules" \
            --exclude "vendor" \
            --exclude "composer.lock" \
            --exclude "tests" \
            --exclude "logs" \
            --exclude ".DS_Store" \
            ./ "${BUILD_DIR}/${PLUGIN_SLUG}/"

          # CRITICAL: Fail if main plugin file is missing
          if [ ! -f "${BUILD_DIR}/${PLUGIN_SLUG}/${MAIN_FILE}" ]; then
            echo "ERROR: Main plugin file is missing: ${PLUGIN_SLUG}/${MAIN_FILE}"
            exit 1
          fi

          # Create ZIP with correct folder structure
          cd "${BUILD_DIR}"
          zip -r "${PLUGIN_SLUG}.zip" "${PLUGIN_SLUG}"

          # Verify ZIP was created
          if [ ! -f "${PLUGIN_SLUG}.zip" ]; then
            echo "ERROR: ZIP file was not created"
            exit 1
          fi

      - name: Validate ZIP structure
        env:
          PLUGIN_SLUG: webp-media-handler
          MAIN_FILE: webp-media-handler.php
        run: |
          set -euo pipefail

          ZIP_PATH="${GITHUB_WORKSPACE}/build/${PLUGIN_SLUG}.zip"
          
          # CRITICAL: Fail if ZIP doesn't exist
          if [ ! -f "${ZIP_PATH}" ]; then
            echo "ERROR: Release ZIP not found: ${ZIP_PATH}"
            exit 1
          fi

          # CRITICAL: Fail if ZIP contains files outside the plugin folder
          # WordPress requires the ZIP to extract to exactly: webp-media-handler/
          if unzip -Z -1 "${ZIP_PATH}" | grep -v "^${PLUGIN_SLUG}/" >/dev/null; then
            echo "ERROR: ZIP contains files outside ${PLUGIN_SLUG}/ directory"
            echo "Files found:"
            unzip -Z -1 "${ZIP_PATH}" | grep -v "^${PLUGIN_SLUG}/"
            exit 1
          fi

          # CRITICAL: Fail if main plugin file is missing from ZIP
          if ! unzip -Z -1 "${ZIP_PATH}" | grep -q "^${PLUGIN_SLUG}/${MAIN_FILE}$"; then
            echo "ERROR: ZIP missing required file: ${PLUGIN_SLUG}/${MAIN_FILE}"
            echo "Files in ZIP:"
            unzip -Z -1 "${ZIP_PATH}" | head -20
            exit 1
          fi

          # Verify ZIP extracts to correct folder structure
          EXTRACT_DIR="${GITHUB_WORKSPACE}/extract-test"
          rm -rf "${EXTRACT_DIR}"
          mkdir -p "${EXTRACT_DIR}"
          
          cd "${EXTRACT_DIR}"
          unzip -q "${ZIP_PATH}"
          
          # Check that extracted folder name is exactly the plugin slug
          if [ ! -d "${PLUGIN_SLUG}" ]; then
            echo "ERROR: ZIP does not extract to folder: ${PLUGIN_SLUG}"
            echo "Extracted contents:"
            ls -la
            exit 1
          fi
          
          # Check that main file exists in extracted folder
          if [ ! -f "${PLUGIN_SLUG}/${MAIN_FILE}" ]; then
            echo "ERROR: Main plugin file missing in extracted ZIP"
            exit 1
          fi
          
          # Cleanup test extraction
          rm -rf "${EXTRACT_DIR}"
          
          echo "âœ“ ZIP structure validated successfully"

      - name: Upload release asset
        # CRITICAL: This step will fail if ZIP upload fails, preventing release publication
        uses: softprops/action-gh-release@v2
        with:
          files: build/webp-media-handler.zip
          # Only create/update release if ZIP upload succeeds
          fail_on_unmatched_files: true
