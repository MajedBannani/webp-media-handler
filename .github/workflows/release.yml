name: Build and release plugin ZIP

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build plugin ZIP
        env:
          PLUGIN_SLUG: webp-media-handler
          MAIN_FILE: webp-media-handler.php
        run: |
          set -euo pipefail

          BUILD_DIR="${GITHUB_WORKSPACE}/build"
          rm -rf "${BUILD_DIR}"
          mkdir -p "${BUILD_DIR}/${PLUGIN_SLUG}"

          rsync -a --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "node_modules" \
            --exclude "vendor" \
            --exclude "composer.lock" \
            --exclude "tests" \
            --exclude "logs" \
            --exclude ".DS_Store" \
            ./ "${BUILD_DIR}/${PLUGIN_SLUG}/"

          if [ ! -f "${BUILD_DIR}/${PLUGIN_SLUG}/${MAIN_FILE}" ]; then
            echo "Main plugin file is missing: ${PLUGIN_SLUG}/${MAIN_FILE}"
            exit 1
          fi

          cd "${BUILD_DIR}"
          zip -r "${PLUGIN_SLUG}.zip" "${PLUGIN_SLUG}"

      - name: Validate ZIP structure
        env:
          PLUGIN_SLUG: webp-media-handler
          MAIN_FILE: webp-media-handler.php
        run: |
          set -euo pipefail

          ZIP_PATH="${GITHUB_WORKSPACE}/build/${PLUGIN_SLUG}.zip"
          if [ ! -f "${ZIP_PATH}" ]; then
            echo "Release ZIP not found: ${ZIP_PATH}"
            exit 1
          fi

          if unzip -Z -1 "${ZIP_PATH}" | grep -v "^${PLUGIN_SLUG}/" >/dev/null; then
            echo "ZIP contains files outside ${PLUGIN_SLUG}/. Aborting."
            exit 1
          fi

          if ! unzip -Z -1 "${ZIP_PATH}" | grep -q "^${PLUGIN_SLUG}/${MAIN_FILE}$"; then
            echo "ZIP missing ${PLUGIN_SLUG}/${MAIN_FILE}. Aborting."
            exit 1
          fi

      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: build/webp-media-handler.zip
